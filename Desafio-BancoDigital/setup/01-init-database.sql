-- Script de inicialização do banco de dados Oracle para o Banco Digital
-- Este script será executado automaticamente quando o container Oracle subir

-- Conectar como SYSTEM
CONNECT SYSTEM/BancoDigital123@XE;

-- Criar as tabelas necessárias para o sistema

-- Tabela CONTA_CORRENTE
CREATE TABLE CONTA_CORRENTE (
    ID NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NUMERO VARCHAR2(20) NOT NULL UNIQUE,
    CPF VARCHAR2(11) NOT NULL UNIQUE,
    NOME VARCHAR2(100) NOT NULL,
    SENHA_HASH VARCHAR2(255) NOT NULL,
    SALDO NUMBER(15,2) DEFAULT 0,
    ATIVA NUMBER(1) DEFAULT 1,
    DATA_ABERTURA DATE DEFAULT SYSDATE,
    DATA_ATUALIZACAO DATE DEFAULT SYSDATE
);

-- Tabela MOVIMENTO
CREATE TABLE MOVIMENTO (
    ID NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CONTA_ID NUMBER(10) NOT NULL,
    TIPO_MOVIMENTO CHAR(1) NOT NULL CHECK (TIPO_MOVIMENTO IN ('C', 'D')),
    VALOR NUMBER(15,2) NOT NULL CHECK (VALOR > 0),
    CHAVE_IDEMPOTENCIA VARCHAR2(50) NOT NULL UNIQUE,
    DATA_MOVIMENTO DATE DEFAULT SYSDATE,
    CONSTRAINT FK_MOVIMENTO_CONTA FOREIGN KEY (CONTA_ID) REFERENCES CONTA_CORRENTE(ID)
);

-- Tabela TRANSFERENCIA
CREATE TABLE TRANSFERENCIA (
    ID NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CONTA_ORIGEM_ID NUMBER(10) NOT NULL,
    CONTA_DESTINO_ID NUMBER(10) NOT NULL,
    VALOR NUMBER(15,2) NOT NULL CHECK (VALOR > 0),
    CHAVE_IDEMPOTENCIA VARCHAR2(50) NOT NULL UNIQUE,
    STATUS VARCHAR2(20) DEFAULT 'PROCESSADA',
    DATA_TRANSFERENCIA DATE DEFAULT SYSDATE,
    CONSTRAINT FK_TRANSFERENCIA_ORIGEM FOREIGN KEY (CONTA_ORIGEM_ID) REFERENCES CONTA_CORRENTE(ID),
    CONSTRAINT FK_TRANSFERENCIA_DESTINO FOREIGN KEY (CONTA_DESTINO_ID) REFERENCES CONTA_CORRENTE(ID),
    CONSTRAINT CHK_CONTAS_DIFERENTES CHECK (CONTA_ORIGEM_ID != CONTA_DESTINO_ID)
);

-- Tabela IDEMPOTENCIA
CREATE TABLE IDEMPOTENCIA (
    ID NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CHAVE VARCHAR2(50) NOT NULL UNIQUE,
    RESULTADO CLOB,
    DATA_CRIACAO DATE DEFAULT SYSDATE,
    DATA_EXPIRACAO DATE DEFAULT SYSDATE + 1
);

-- Criar índices para melhor performance
CREATE INDEX IDX_CONTA_CPF ON CONTA_CORRENTE(CPF);
CREATE INDEX IDX_CONTA_NUMERO ON CONTA_CORRENTE(NUMERO);
CREATE INDEX IDX_MOVIMENTO_CONTA ON MOVIMENTO(CONTA_ID);
CREATE INDEX IDX_MOVIMENTO_DATA ON MOVIMENTO(DATA_MOVIMENTO);
CREATE INDEX IDX_MOVIMENTO_IDEMPOTENCIA ON MOVIMENTO(CHAVE_IDEMPOTENCIA);
CREATE INDEX IDX_TRANSFERENCIA_ORIGEM ON TRANSFERENCIA(CONTA_ORIGEM_ID);
CREATE INDEX IDX_TRANSFERENCIA_DESTINO ON TRANSFERENCIA(CONTA_DESTINO_ID);
CREATE INDEX IDX_TRANSFERENCIA_DATA ON TRANSFERENCIA(DATA_TRANSFERENCIA);
CREATE INDEX IDX_IDEMPOTENCIA_CHAVE ON IDEMPOTENCIA(CHAVE);
CREATE INDEX IDX_IDEMPOTENCIA_EXPIRACAO ON IDEMPOTENCIA(DATA_EXPIRACAO);

-- Confirmar as transações
COMMIT;
EXIT;